function [c]=constructC_v2(Sigma,Masks,H,Set)
n=size(Masks{1},1);
S=length(Sigma);
c=zeros(n*S,1);
tic
for i=1:S
    for j= Set(i,1)+1:Set(i,2)+1
 %       if j-1>= Set(i,1) && j-1 <= Set(i,2)
            T=CreateTranslationMatrix(j-1,n);
%             Aux=zeros(n);
%             Aux(Masks{i}==1,Masks{i}==1)=Sigma{i};
%             Aux=T'*Aux*T;
%             TrsMask=T*Masks{i};
%             TrsMask=(TrsMask==1);
%             Aux=Aux(TrsMask,TrsMask);
%             c((i-1)*n+j)=trace(H(TrsMask,TrsMask)*Aux)

TransH=(circshift(H',-(j-1)))';
TransH=circshift(TransH,-(j-1));
%TransH=T*H*T';
Aux=Sigma{i};
c((i-1)*n+j)=trace(TransH(Masks{i}==1,Masks{i}==1)*Aux);
%       end
    end
end
Timeloop=toc